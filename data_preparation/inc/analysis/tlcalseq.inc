C
      INTEGER    MAXCEL,NHIT,NCELLS
      REAL       HITCEL,RUMORE,SPTAG,IMBAL,MTOG
      REAL       EMCCUT,HAC0CUT,HACCUT
      PARAMETER (EMCCUT=60.,HAC0CUT=100.,HACCUT=110.)
      PARAMETER (SPTAG=0.9,IMBAL=0.9,MTOG=0.001)
      PARAMETER (HITCEL=1500.)
      PARAMETER (RUMORE=1000.)
      PARAMETER (MAXCEL = 5953)
      REAL       PC(MAXCEL,9)
      REAL       TC(MAXCEL,2)
      REAL       RAWDAT(MAXCEL,5)
      COMMON /CELVEC/ NHIT,NCELLS,PC,TC,RAWDAT

C***********************************************************************
C*     MAXCEL  = MAX. NUMBER OF CELLS ABOVE THRESHOLD PLUS JETS, THIS IS
C*               NORMALLY ABOUT 250, SO THE 5953 COULD BE LOWERED
C*     NHIT    = NUMBER OF HIT CELLS
C*     NCELLS  = ACTUAL NUMBER OF CELLS ABOVE THRESHOLD (# ENTRIES IN PC)
C*
C*     PC(I,1) = E*SIN_THETA*COS_PHI (MeV)
C*     PC(I,2) = E*SIN_THETA*SIN_PHI (MeV)
C*     PC(I,3) = E*COS_THETA (MeV)
C*     PC(I,4) = E (MeV)
C*     PC(I,5) = INTERAL USE FOR CLUSTERING
C*     PC(I,6) = CELL TYPE
C*     PC(I,7) = CELL NUMBER
C*     PC(I,8) = AVERAGE CELL TIME (ns) ([Tlow+Thigh]/2)
C*     PC(I,9) = ENERGY IMBALANCE OF CELL (Ehgh-Elow) (MeV)
C*
C*     TC(I,1) = LOW PMT TIME OF CELL (ns)
C*     TC(I,2) = HIGH PMT TIME OF CELL (ns)
C*
C*     RAWDAT(J,1) = CELNUM
C*     RAWDAT(J,2) = E FROM LOW PMT (MeV)
C*     RAWDAT(J,3) = E FROM HIGH PMT (MeV)
C*     RAWDAT(J,4) = T FROM LOW PMT (ns)
C*     RAWDAT(J,5) = T FROM HIGH PMT (ns)
C************************************************************************


      INTEGER CELTYP,CELNUM
      REAL    CELENE,CELENX,CELENY,CELENZ,CELPX,CELPY,CELPZ,CELET
      LOGICAL CELERR
      INTEGER FEMC,FHAC0,FHAC1,FHAC2
      INTEGER BEMC,BHAC1,BHAC2
      INTEGER REMC,RHAC0,RHAC1
      PARAMETER(FEMC = 1,BEMC = 2,REMC = 3)
      PARAMETER(FHAC0 = 4,RHAC0 = 5)
      PARAMETER(FHAC1 = 6,FHAC2 = 7,BHAC1 = 8,BHAC2 = 9,RHAC1 = 10)
      COMMON /CELL/ CELNUM,CELTYP,CELENE,CELERR,
     +              CELENX,CELENY,CELENZ,CELPX,CELPY,CELPZ,CELET
C***********************************************************************
C*     MTOG    = CONVERSION FROM MEV TO GEV
C*     CELNUM  = RECONSTRUCTION SCHEME CELL NUMBER
C*     CELTYP  = CELL TYPE (FEMC, FHAC0, ...)
C*     CELENE  = CELL ENERGY (MeV)
C*     CELENX  = CELENE*ABS(SIN(THETA)*COS(PHI)) (MeV)
C*     CELENY  = CELENE*ABS(SIN(THETA)*SIN(PHI)) (MeV)
C*     CELENZ  = CELENE*ABS(COS(THETA)) (MeV)
C*     CELPX   = CELENE*SIN(THETA)*COS(PHI) (MeV)
C*     CELPY   = CELENE*SIN(THETA)*SIN(PHI) (MeV)
C*     CELPZ   = CELENE*COS(THETA) (MeV)
C*     CELET   = ABS(CELENE*SIN(THETA)) (MeV)
C***********************************************************************C
      INTEGER    MAXID,CELTOT
      PARAMETER (MAXID = 44398)
      PARAMETER (CELTOT = 5953)
      REAL       PI
      PARAMETER (PI = 3.1415927)
      REAL       THETA,PHI,RADIUS
      INTEGER    RT(MAXID)
      REAL       GEOM(CELTOT,9)
      INTEGER    BADLIST(CELTOT)
      COMMON /COORD/ RADIUS,THETA,PHI,GEOM,BADLIST,RT
C*********************************************************************
C*     MAXID   = MAXIMUM CELL ID NUMBER IN THE RECONSTRUCTION SCHEME
C*     CELTOT  = TOTAL NUMBER OF CELLS IN CALORIMETER
C*     PI      = VALUE OF PI FOR CALCULATIONS
C*     THETA   = THETA ANGLE OF CELL
C*     PHI     = PHI ANGLE OF CELL
C*     RADIUS  = DISTANCE OF CELL FROM ORIGIN
C*
C*     RT      = TRANSFORMATION MATRIX - RELATES ELEMENTS OF GEOM
C*               ARRAY TO THE CELL NUMBER
C*
C*     BADLIST(K) = 1  -->  LOW PMT IS A BAD CHANNEL
C*                  2  -->  HIGH PMT IS A BAD CHANNEL
C*
C*     GEOM(K,1) = CELL NUMBER
C*     GEOM(K,2) = CELL RADIUS
C*     GEOM(K,3) = CELL THETA
C*     GEOM(K,4) = CELL PHI
C*     GEOM(K,5) = CELL TYPE (SEE COMMON /CELL/)
C*     GEOM(K,6) = IDENTIFIES SPECIAL CELLS (SEE BELOW)
C*     GEOM(K,7) = CELL X
C*     GEOM(K,8) = CELL Y
C*     GEOM(K,9) = CELL Z
C*
C*     GEOM(K,6) = 0  -->  FCAL CELL
C*                 1  -->  FCAL INNER RING (ALL INSIDE 10 DEGREE CONE)
C*                 2  -->  FCAL INNER 2ND RING - CORNERS
C*                 3  -->  CORNERS OF FCAL INNER 2ND RING
C*                         THE CORNERS ARE TOWER,MODULE NUMBERS
C*                         10,10 AND 10,14 AND 14,10 AND 14,14
C*                 10 -->  BCAL CELL
C*                 20 -->  RCAL CELL
C*                 21 -->  RCAL INNER RING
C*********************************************************************
      REAL              A_TIME(10),B_TIME(10),C_TIME(10)
      COMMON /TIMETEMP/ A_TIME,B_TIME,C_TIME
C*********************************************************************
C*    BRUCE STRAUB TIME CORRECTIONS ACCORDING TO THE EQUATION
C*
C*                     A = B/E**C
C*
C*    DESIGNED SO THAT EACH TYPE OF CELL CAN HAVE ITS OWN
C*    PARAMETERIZATION. THE ARRAYS ARE FILLED IN THE ROUTINE
C*    CALGEO (DONE AT SETUP)
C*********************************************************************
C
      REAL           C5PTIM,C5ETIM,C5PERR,C5EERR,C5PNML,C5ENML
      COMMON /C5TIM/ C5PTIM,C5ETIM,C5PERR,C5EERR,C5PNML,C5ENML
      REAL           C5FCOR,C5BCOR,C5RCOR
      COMMON /C5COR/ C5FCOR,C5BCOR,C5RCOR
C*********************************************************************
C*    C5PTIM = C5 PROTON TIME CORRECTION (ns)
C*    C5ETIM = C5 ELECTRON TIME CORRECTION (ns)
C*    C5PERR = ERROR ON C5 PROTON TIME CORRECTION (ns)
C*    C5EERR = ERROR ON C5 ELECTRON TIME CORRECTION (ns)
C*    C5PNML = NOMINAL C5 PROTON TIME (ns)
C*    C5ENML = NOMINAL C5 ELECTRON TIME (ns)
C*    C5FCOR = C5 CORRECTION TO FCAL TIME (ns)
C*    C5BCOR = C5 CORRECTION TO BCAL TIME (ns)
C*    C5RCOR = C5 CORRECTION TO RCAL TIME (ns)
C*********************************************************************
C
      REAL    ETOT,EXSCA,EYSCA,ELONG,ET,EMISS,EXVEC,EYVEC,EZVEC
      REAL    ETNIN,ETN2IN,EFCALIN,EFCALINR,ETHETA150
      REAL    BPPX,BPPY,EMISSNIN
      INTEGER NFBPMT,NRBPMT
      REAL    BCALE,FCALE,RCALE
      REAL    BCAL_EMC,FCAL_EMC,RCAL_EMC,BCAL_HAC,FCAL_HAC,RCAL_HAC
      REAL    REMCBP,REMCNBP,BEMCF,BEMCR
      REAL    TIMFBP,TIMRBP
      REAL    FBPTIM,RBPTIM
      REAL    FTIM,BTIM,RTIM,GTIM,UTIM,DTIM
      REAL    CFTIM,CBTIM,CRTIM,CGTIM,CUTIM,CDTIM
      INTEGER NFPMT,NBPMT,NRPMT,NGPMT,NUPMT,NDPMT
      REAL    CHI2FTIM,CHI2BTIM,CHI2RTIM,CHI2GTIM
      REAL    FWTSUM(2),BWTSUM(2),RWTSUM(2),GWTSUM(2),CGWTSUM(2)
      REAL    UWTSUM(2),DWTSUM(2),CUWTSUM(2),CDWTSUM(2)
      REAL    FTESUM,BTESUM,RTESUM,GTESUM,UTESUM,DTESUM
      REAL    FTERR,BTERR,RTERR,GTERR,UTERR,DTERR
      COMMON /GLOPRO/ ETOT,EXSCA,EYSCA,ELONG,ET,ETNIN,ETN2IN,EFCALIN,
     +                EFCALINR,ETHETA150,EMISS,EXVEC,EYVEC,EZVEC,
     +                BPPX,BPPY,EMISSNIN,
     +                BCALE,FCALE,RCALE,BCAL_EMC,FCAL_EMC,RCAL_EMC,
     +                BCAL_HAC,FCAL_HAC,RCAL_HAC,REMCBP,REMCNBP,
     +                BEMCF,BEMCR,
     +                FBPTIM,RBPTIM,NFBPMT,NRBPMT,TIMFBP,TIMRBP,
     +                FTIM,BTIM,RTIM,GTIM,UTIM,DTIM,
     +                CFTIM,CBTIM,CRTIM,CGTIM,CUTIM,CDTIM,
     +                NFPMT,NBPMT,NRPMT,NGPMT,NUPMT,NDPMT,
     +                CHI2FTIM,CHI2BTIM,CHI2RTIM,CHI2GTIM,
     +                FWTSUM,BWTSUM,RWTSUM,GWTSUM,UWTSUM,DWTSUM,
     +                CGWTSUM,CUWTSUM,CDWTSUM,
     +                FTESUM,BTESUM,RTESUM,GTESUM,UTESUM,DTESUM,
     +                FTERR,BTERR,RTERR,GTERR,UTERR,DTERR
C***********************************************************************
C*     ETOT   = TOTAL ENERGY DEPOSITED IN CAL (GeV)
C*     EXSCA  = TOTAL SCALAR X COMPONENT OF ENERGY (GeV)
C*     EYSCA  = TOTAL SCALAR Y COMPONENT OF ENERGY (GeV)
C*     ELONG  = TOTAL SCALAR LONGITUDINAL (Z COMP.) ENERGY (GeV)
C*     ET     = TOTAL SCALAR TRANSVERSE ENERGY (GeV)
C*     ETNIN  = TOTAL SCALAR TRANSVERSE ENERGY EXCLUDING FCAL INNER RING (GeV)
C*     ETN2IN = TOTAL SCALAR TRANSVERSE ENERGY EXCLUDING 2 INNER FCAL
C*              RINGS (GeV)
C*     EMISS  = TOTAL MISSING (VECTOR) TRANSVERSE ENERGY (GeV)
C*     EXVEC  = TOTAL X COMPONENT OF VECTOR ENERGY (GeV)
C*     EYVEC  = TOTAL Y COMPONENT OF VECTOR ENERGY (GeV)
C*     EZVEC  = TOTAL (Z COMP.) VECTOR LONGITUDINAL ENERGY (GeV)
C*
C*     BCALE  = TOTAL ENERGY IN BCAL (GeV)
C*     FCALE  = TOTAL ENERGY IN FCAL (GeV)
C*     RCALE  = TOTAL ENERGY IN RCAL (GeV)
C*
C**  NOTE: HAC0 CELLS ARE COUNTED IN THE HAC SUMS, NOT THE EMC SUMS
C*
C*     BCAL_EMC  = TOTAL ENERGY IN BCAL EMC (GeV)
C*     FCAL_EMC  = TOTAL ENERGY IN FCAL EMC INCLUDING BP (GeV)
C*     RCAL_EMC  = TOTAL ENERGY IN RCAL EMC INCLUDING BP (GeV)
C*     BCAL_HAC  = TOTAL ENERGY IN BCAL HAC (GeV)
C*     FCAL_HAC  = TOTAL ENERGY IN FCAL HAC INCLUDING BP (GeV)
C*     RCAL_HAC  = TOTAL ENERGY IN RCAL HAC INCLUDING BP (GeV)
C*
C*     REMCBP    = TOTAL ENERGY INSIDE RCAL EMC BP RING (GeV)
C*     REMCNBP   = TOTAL ENERGY OUTSIDE RCAL EMC BP RING (GeV)
C*
C*     BEMCF     = TOTAL ENERGY IN BCAL FOR Z > 0 (GeV)
C*     BEMCR     = TOTAL ENERGY IN BCAL FOR Z < 0 (GeV) C*
C*     EFCALIN   = FCAL ENERGY INSIDE BEAM-PIPE REGION EXCEPT CORNERS
C*                 (IE TOWERS 10,10 AND 14,14 AND 10,14 AND 14,10)
C*
C*     EFCALINR  = FCAL ENERGY INSIDE BEAM-PIPE REGION
C*                 (SQUARE OF TOWERS 11-13)
C*
C*     ETHETA150 = TOTAL ENERGY IN CELLS WITH THETA > 150 DEGREES (GeV)
C*
C*     FBPTIM = SUM TIME OF ALL FCAL BEAM-PIPE PMTS ABOVE THRESHOLD RUMORE
C*     RBPTIM = SUM TIME OF ALL RCAL BEAM-PIPE PMTS ABOVE THRESHOLD RUMORE
C*     TIMFBP = AVERAGE FCAL BEAM PIPE REGION TIME USED FOR
C*                 BEAM GAS REJECTION CUT (ALREADY BEEN DIVIDED BY
C*                 NUMBER OF PMTS) IF = -100. THEN THERE WERE NOT
C*                 ENOUGH PMTS ABOVE THRESHOLD RUMORE
C*     TIMRBP = AVERAGE RCAL BEAM PIPE REGION TIME USED FOR
C*                 BEAM GAS REJECTION CUT (ALREADY BEEN DIVIDED BY
C*                 NUMBER OF PMTS) IF = -100. THEN THERE WERE NOT
C*                 ENOUGH PMTS ABOVE THRESHOLD RUMORE
C*     NFBPMT = NUMBER OF PMTS IN FCAL BEAM PIPE REGION WITH ENERGY
C*              ABOVE RUMORE
C*     NRBPMT = NUMBER OF PMTS IN RCAL BEAM PIPE REGION WITH ENERGY
C*              ABOVE RUMOREC*
C*     FTIM  = WEIGHTED AVERAGE FCAL TIME
C*     BTIM  = WEIGHTED AVERAGE BCAL TIME
C*     RTIM  = WEIGHTED AVERAGE RCAL TIME
C*     GTIM  = WEIGHTED AVERAGE CAL TIME
C*     UTIM  = WEIGHTED AVERAGE UPPER CAL TIME
C*     DTIM  = WEIGHTED AVERAGE LOWER CAL TIME
C*     CFTIM = WEIGHTED AVERAGE FCAL TIME (CORRECTED FOR C5)
C*     CBTIM = WEIGHTED AVERAGE BCAL TIME (CORRECTED FOR C5)
C*     CRTIM = WEIGHTED AVERAGE RCAL TIME (CORRECTED FOR C5)
C*     CGTIM = WEIGHTED AVERAGE CAL TIME (CORRECTED FOR C5)
C*     CUTIM = WEIGHTED AVERAGE UPPER CAL TIME (CORRECTED FOR C5)
C*     CDTIM = WEIGHTED AVERAGE LOWER CAL TIME (CORRECTED FOR C5)
C*     NFPMT = NUMBER OF FCAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     NBPMT = NUMBER OF BCAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     NRPMT = NUMBER OF RCAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     NGPMT = NUMBER OF CAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     NUPMT = NUMBER OF UPPER CAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     NDPMT = NUMBER OF LOWER CAL PMT TUBES ABOVE THRESHOLD (200 MEV)
C*     FWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL FCAL PMTS ABOVE 200 MeV
C*     FWTSUM(2)  = SUM OF FWTSUM(1) * TIME (OF PMT)
C*     BWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL BCAL PMTS ABOVE 200 MeV
C*     BWTSUM(2)  = SUM OF BWTSUM(1) * TIME (OF PMT)
C*     RWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL RCAL PMTS ABOVE 200 MeV
C*     RWTSUM(2)  = SUM OF RWTSUM(1) * TIME (OF PMT)
C*     GWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL CAL PMTS ABOVE 200 MeV
C*     GWTSUM(2)  = SUM OF GWTSUM(1) * TIME (OF PMT)
C*     CGWTSUM(2) = C5 CORRECTED SUM OF GWTSUM(1) * TIME (OF PMT)
C*     UWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL UPPER CAL PMTS ABOVE 200 MeV
C*     UWTSUM(2)  = SUM OF UWTSUM(1) * TIME (OF PMT)
C*     CUWTSUM(2) = C5 CORRECTED SUM OF UWTSUM(1) * TIME (OF PMT)
C*     DWTSUM(1)  = SUM OF 1/TIMEERROR(E) FOR ALL LOWER CAL PMTS ABOVE 200 MeV
C*     DWTSUM(2)  = SUM OF DWTSUM(1) * TIME (OF PMT)
C*     CDWTSUM(2) = C5 CORRECTED SUM OF DWTSUM(1) * TIME (OF PMT)
C*     FTESUM = TOTAL FCAL ENERGY OF ALL PMTS INVOLVED IN AVERAGE TIME
C*     BTESUM = TOTAL BCAL ENERGY OF ALL PMTS INVOLVED IN AVERAGE TIME
C*     RTESUM = TOTAL RCAL ENERGY OF ALL PMTS INVOLVED IN AVERAGE TIME
C*     GTESUM = TOTAL CAL ENERGY OF ALL PMTS INVOLVED IN AVERAGE TIME
C*     UTESUM = TOTAL CAL ENERGY OF ALL UPPER PMTS INVOLVED IN AVERAGE TIME
C*     DTESUM = TOTAL CAL ENERGY OF ALL LOWER PMTS INVOLVED IN AVERAGE TIME
C*     FTERR  = FCAL TIME ERROR (SQRT(1./FWTSUM(1)))
C*     BTERR  = BCAL TIME ERROR (SQRT(1./BWTSUM(1)))
C*     RTERR  = RCAL TIME ERROR (SQRT(1./RWTSUM(1)))
C*     GTERR  = CAL TIME ERROR (SQRT(1./GWTSUM(1)))
C*     UTERR  = UPPER CAL TIME ERROR (SQRT(1./UWTSUM(1)))
C*     DTERR  = LOWER CAL TIME ERROR (SQRT(1./DWTSUM(1)))
C***********************************************************************
C
      INTEGER         BSPCUT,FSPCUT,RSPCUT,SPCNT,SPNUM
      REAL            ESPARK
      INTEGER         CALBG,CALENBG,CALTIBG,TIGHTBG
      INTEGER         CALTIF,CALTIFR,CALTIR,CALTIG
      INTEGER         CALTIC5F,CALTIC5FR,CALTIC5R,CALTIC5G
      REAL            SPENE,SPTIML,SPTIMH
      COMMON /CALCUT/ BSPCUT, SPCNT,SPENE,SPTIML,SPTIMH,SPNUM,ESPARK,
     +                CALBG,CALENBG,FSPCUT,RSPCUT,
     +                CALTIBG,TIGHTBG,CALTIF,CALTIFR,CALTIR,CALTIG,
     +                CALTIC5F,CALTIC5FR,CALTIC5R,CALTIC5G
C***********************************************************************
C*    BSPCUT   = 1 IF EVENT IS A BCAL SPARK EVENT
C*    FSPCUT   = 1 IF EVENT IS A FCAL SPARK EVENT
C*    RSPCUT   = 1 IF EVENT IS A RCAL SPARK EVENT
C*    SPCNT    = SPARK COUNTER
C*    SPNUM    = INDEX OF LAST SPARK FOUND IN RAWDAT
C*    SPENE    = ENERGY OF LAST SPARK FOUND
C*    ESPARK   = ENERGY FROM ASYMETRIC CELLS
C*    SPTIMH/L = HIGH/LOW TIMES FOR LAST SPARK FOUND
C*    CALBG    = 1 IF EVENT THOUGHT TO BE BEAM GAS ON BASIS OF TIMING
C*    CALENBG  = 1 IF EVENT IS THOUGHT TO BE BG BY ENERGY CUTS
C*               (ENERGY AROUND FORWARD BEAM PIPE)
C*    CALTIBG   = 1 IF BACKGROUND ON BASIS OF NEW BS TIMING
C*    CALTIF    = 1 IF BACKGROUND ON BASIS OF FCAL TIMING
C*    CALTIFR   = 1 IF BACKGROUND ON BASIS OF FCAL-RCAL TIMING
C*    CALTIR    = 1 IF BACKGROUND ON BASIS OF RCAL TIMING
C*    CALTIG    = 1 IF BACKGROUND ON BASIS OF GLOBAL TIMING
C*    CALTIC5F  = 1 IF BACKGROUND ON BASIS OF FCAL TIMING, C5 CORRECTED
C*    CALTIC5FR = 1 IF BACKGROUND ON BASIS OF FCAL-RCAL TIMING, C5 CORRECTED
C*    CALTIC5R  = 1 IF BACKGROUND ON BASIS OF RCAL TIMING, C5 CORRECTED
C*    CALTIC5G  = 1 IF BACKGROUND ON BASIS OF GLOBAL TIMING, C5 CORRECTED
C*    TIGHTBG   = 1 IF BACKGROUND ON BASIS OF TIGHT TIMING
C***********************************************************************
